<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC streaming</title>
</head>
<body>
    <h1>WebRTC video Streaming</h1>
    <video id="video" autoplay playsinline></video>
    <button id="stop">Stop</button>
    <script>
        const video = document.getElementById('video');

        async function start() {
            const stream = await navigator.mediaDevices.getUserMedia({video: true});
            video.srcObject = stream;

            const pc = new RTCPeerConnection();
            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            pc.onicecandidate = event => {
                if (event.candidate) {
                    fetch('/candidate', {
                        method: 'POST',
                        body: JSON.stringify(event.candidate.toJSON()),
                        headers: {'Content-Type': 'application/json'}
                    });
                }
            };
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            const response = await fetch('/offer', {
                method: 'POST',
                body: JSON.stringify(pc.localDescription),
                headers: {'Content-Type': 'application/json'}
            });
            const answer = await response.json();
            await pc.setRemoteDescription(answer);
        }
        document.getElementById('stop').onclick = () => {
            pc.getSenders().forEach(sender => sender.track.stop());
            pc.close();
            fetch('/shutdown', {method: 'POST'});
        };


        start();
    </script>

</body>
</html>